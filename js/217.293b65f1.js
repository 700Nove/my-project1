"use strict";(self["webpackChunkpet"]=self["webpackChunkpet"]||[]).push([[217],{8217:function(e,t,s){s.r(t),s.d(t,{default:function(){return h}});var a=function(){var e=this,t=e._self._c;return t("div",{staticClass:"orders-wrapper"},[t("el-card",{staticClass:"main-card",attrs:{shadow:"hover"}},[t("div",{staticClass:"action-bar"},[t("div",{staticClass:"left-actions"},[t("el-popconfirm",{attrs:{title:"确认删除?"},on:{confirm:e.batchDelete},scopedSlots:e._u([{key:"reference",fn:function(){return[t("el-button",{attrs:{type:"danger",icon:"el-icon-delete",size:"medium"}},[e._v("批量删除")])]},proxy:!0}])})],1),t("div",{staticClass:"right-actions"},[t("el-button",{attrs:{type:"success",icon:"el-icon-download",size:"medium"},on:{click:function(t){e.exportVisible=!0}}},[e._v("导出数据")])],1)]),t("el-form",{ref:"searchForm",staticClass:"search-form",attrs:{inline:!0,model:e.listQuery,"label-width":"90px"}},[t("el-form-item",{attrs:{label:"订单号"}},[t("el-input",{attrs:{placeholder:"订单号","prefix-icon":"el-icon-document"},model:{value:e.listQuery.orderNo,callback:function(t){e.$set(e.listQuery,"orderNo",t)},expression:"listQuery.orderNo"}})],1),t("el-form-item",{attrs:{label:"用户名"}},[t("el-input",{attrs:{placeholder:"用户名","prefix-icon":"el-icon-user"},model:{value:e.listQuery.username,callback:function(t){e.$set(e.listQuery,"username",t)},expression:"listQuery.username"}})],1),t("el-form-item",{attrs:{label:"商品名称"}},[t("el-input",{attrs:{placeholder:"商品名称","prefix-icon":"el-icon-goods"},model:{value:e.listQuery.goodsName,callback:function(t){e.$set(e.listQuery,"goodsName",t)},expression:"listQuery.goodsName"}})],1),t("el-form-item",[t("el-button",{attrs:{type:"primary",icon:"el-icon-search"},on:{click:e.onSubmit}},[e._v("查询")]),t("el-button",{attrs:{icon:"el-icon-refresh"},on:{click:e.onReset}},[e._v("重置")])],1)],1),t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.listLoading,expression:"listLoading"}],ref:"multipleTable",staticClass:"orders-table",attrs:{data:e.tableData,"tooltip-effect":"dark",border:"",stripe:""},on:{"selection-change":e.handleSelectionChange}},[t("el-table-column",{attrs:{type:"selection",width:"60",align:"center"}}),t("el-table-column",{attrs:{prop:"orderNo",label:"订单号",align:"center",sortable:"","min-width":"120"}}),t("el-table-column",{attrs:{prop:"username",label:"用户名",align:"center","min-width":"100"}}),t("el-table-column",{attrs:{prop:"goodsName",label:"商品名称",align:"center","min-width":"150","show-overflow-tooltip":""}}),t("el-table-column",{attrs:{prop:"num",label:"商品数量",align:"center",width:"100"}}),t("el-table-column",{attrs:{prop:"totalAmount",label:"总金额",align:"center",width:"100"}}),t("el-table-column",{attrs:{prop:"status",label:"订单状态",align:"center",width:"120"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("el-tag",{attrs:{type:e.statusType(s.row.status),size:"small"}},[e._v(e._s(e.statusText(s.row.status)))])]}}])}),t("el-table-column",{attrs:{prop:"time",label:"时间",align:"center","min-width":"120"}}),t("el-table-column",{attrs:{label:"操作",align:"center",width:"200",fixed:"right"},scopedSlots:e._u([{key:"default",fn:function(s){return["USER"!=e.userInfo.role?t("el-button",{staticClass:"delete-btn",attrs:{type:"text",size:"small",icon:"el-icon-delete"},on:{click:function(t){return e.handleDelete(s.$index,s.row)}}},[e._v("删除")]):e._e(),e.isShowUpdateButton(s.row.status)?t("el-button",{attrs:{size:"small",type:"text",type:e.updateStatusButtonType(s.row.status)},on:{click:function(t){return e.handleUpdateStatus(s.row)}}},[t("i",{class:e.getStatusActionIcon(s.row.status)}),e._v(" "+e._s(e.updateStatusButtonName(s.row.status))+" ")]):e._e()]}}])})],1),t("div",{staticClass:"pagination-container"},[t("Pagination",{attrs:{total:e.total,page:e.listQuery.currentPage,limit:e.listQuery.pageSize},on:{"update:page":function(t){return e.$set(e.listQuery,"currentPage",t)},"update:limit":function(t){return e.$set(e.listQuery,"pageSize",t)},pagination:e.fetchData}})],1),t("el-dialog",{staticClass:"export-dialog",attrs:{title:"导出数据",visible:e.exportVisible,width:"500px",modal:!1},on:{"update:visible":function(t){e.exportVisible=t}}},[t("div",{staticClass:"export-options"},[t("el-button",{attrs:{type:"primary",icon:"el-icon-document"},on:{click:function(t){return e.exportTable("xlsx")}}},[e._v("EXCEL格式")]),t("el-button",{attrs:{type:"success",icon:"el-icon-document"},on:{click:function(t){return e.exportTable("csv")}}},[e._v("CSV格式")]),t("el-button",{attrs:{type:"info",icon:"el-icon-document"},on:{click:function(t){return e.exportTable("txt")}}},[e._v("TXT格式")])],1),t("div",{staticClass:"export-tip"},[e._v("请选择要导出数据的格式")])])],1)],1)},o=[],i=s(186),r=s(1184),n=s(7120),l={name:"Orders",inject:["userInfo"],components:{Pagination:r.A},data(){return{listLoading:!0,listQuery:{orderNo:void 0,username:void 0,goodsName:void 0,currentPage:1,pageSize:10},total:0,tableData:[],multipleSelection:[],exportVisible:!1}},created(){this.fetchData()},methods:{getStatusActionIcon(e){switch(e){case"W_Pay":return"el-icon-wallet";case"W_Ship":return"el-icon-box";case"W_Pickup":return"el-icon-box";default:return"el-icon-check"}},statusType(e){const t={W_Pay:"danger",W_Ship:"warning",W_Pickup:"primary",Completed:"success"};return t[e]||"info"},statusText(e){const t={W_Pay:"待支付",W_Ship:"待发货",W_Pickup:"待自提",Completed:"已完成"};return t[e]||"未知状态"},isShowUpdateButton(e){if("USER"===this.userInfo.role){if("W_Pay"==e||"W_Pickup"==e)return!0}else if("W_Ship"===e)return!0},handleUpdateStatus(e){var t;const s=e.status;switch(s){case"W_Pay":this.handlePay(e.orderNo);break;case"W_Ship":e.status="W_Pickup",t="货品已准备好，等待用户自提";break;case"W_Pickup":this.handleConfirmPickup(e.orderNo);break;default:t="",this.$message.error("非法操作!");break}"W_Pay"==s||"W_Pickup"==s||this.handleEditSave(e,t)||(e.status=s),this.fetchData()},handlePay(e){this.$confirm("请选择支付方式","支付选择",{confirmButtonText:"支付宝支付",cancelButtonText:"余额支付",distinguishCancelAndClose:!0,closeOnClickModal:!1,center:!0,type:"info",customClass:"payment-dialog",roundButton:!0}).then((()=>{window.open("http://localhost:8889/alipay/pay?orderNo="+e)})).catch((t=>{"cancel"===t&&this.handleBalancePay(e)}))},handleBalancePay(e){const t=this.$loading({lock:!0,text:"正在处理支付请求...",spinner:"el-icon-loading",background:"rgba(255, 255, 255, 0.7)"});n.A.get("/orders/getByOrderNo/"+e).then((s=>{if("0"===s.code){const a=s.data;if(this.userInfo.account<a.totalAmount)return t.close(),void this.$message({type:"error",message:"您的余额不足，请充值或选择其他支付方式",showClose:!0,duration:3e3});n.A.post("/orders/balancePay",{orderNo:e,userId:this.userInfo.id}).then((e=>{t.close(),"0"===e.code?(this.$message({type:"success",message:"支付成功，您的余额已扣除",showClose:!0,duration:3e3}),this.userInfo.account-=a.totalAmount,this.fetchData()):this.$message({type:"error",message:e.msg||"支付失败，请稍后再试",showClose:!0,duration:3e3})})).catch((e=>{t.close(),console.error(e),this.$message({type:"error",message:"支付出错，请稍后再试",showClose:!0,duration:3e3})}))}else t.close(),this.$message({type:"error",message:"获取订单信息失败",showClose:!0,duration:3e3})})).catch((e=>{t.close(),console.error(e),this.$message({type:"error",message:"获取订单信息失败",showClose:!0,duration:3e3})}))},updateStatusButtonName(e){switch(e){case"W_Pay":return"支付";case"W_Ship":return"确认备货完成";case"W_Pickup":return"确认自提";default:return"订单异常"}},updateStatusButtonType(e){switch(e){case"W_Pay":return"warning";case"W_Ship":return"warning";case"W_Pickup":return"primary";case"Completed":return"success";default:return"danger"}},handleSelectionChange(e){this.multipleSelection=e.map((e=>e.id))},handleDelete(e,t){this.$confirm("此操作将删除选中数据, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{n.A.delete("/orders/"+t.id).then((e=>{"0"==e.code?(this.$message({type:"success",message:"删除成功!"}),this.onReset()):this.$message({type:"error",message:e.msg})}))})).catch((()=>{this.$message({type:"info",message:"已取消删除"})}))},batchDelete(){this.multipleSelection.length<1?this.$message({message:"请先选择要删除的数据！",type:"warning"}):n.A.delete(`/orders/deleteBatch?ids=${this.multipleSelection.join(",")}`).then((e=>{"0"===e.code?(this.$message({showClose:!0,message:"批量删除成功",type:"success"}),this.onReset()):this.$message({showClose:!0,message:e.msg,type:"error"})}))},fetchData(){this.listLoading=!0,n.A.get("/orders/page",{params:{orderNo:this.listQuery.orderNo,username:this.listQuery.username,goodsName:this.listQuery.goodsName,userRole:this.userInfo.role,userId:this.userInfo.id,currentPage:this.listQuery.currentPage,size:this.listQuery.pageSize}}).then((e=>{const t=e.data;"0"===e.code&&(this.total=t.total,this.tableData=t.records)})),this.listLoading=!1},onSubmit(){this.listQuery.currentPage=1,this.fetchData()},onReset(){this.listQuery.currentPage=1,this.listQuery.pageSize=10,this.listQuery.goodsName="",this.listQuery.username="",this.listQuery.orderNo="",this.fetchData()},handleEditSave(e,t){n.A.put("/orders/"+e.id,e).then((e=>0==e.code?(this.$message({showClose:!0,message:t,type:"success"}),this.fetchData(),!0):(this.$message({showClose:!0,message:e.msg,type:"error"}),this.fetchData(),!1)))},exportTable(e){if(this.tableData.length){const t={header:["编号","订单号","用户名","商品名称","商品ID","用户ID","商品数量","订单状态","时间"],key:["id","orderNo","username","goodsName","goodsId","userId","num","status","time"],data:this.tableData,autoWidth:!0,fileName:"订单数据",bookType:e};i.Ay.exportDataToExcel(t),this.exportVisible=!1}},handleSizeChange(e){this.listQuery.pageSize=e,this.fetchData()},handleCurrentChange(e){this.listQuery.currentPage=e,this.fetchData()},handleConfirmPickup(e){this.$confirm("确认已自提商品?","确认自提",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{const t=this.$loading({lock:!0,text:"正在处理自提确认...",spinner:"el-icon-loading",background:"rgba(255, 255, 255, 0.7)"});n.A.post("/orders/confirmPickup",{orderNo:e,userId:this.userInfo.id}).then((e=>{t.close(),"0"===e.code?(this.$message({type:"success",message:"确认自提成功，订单已完成",showClose:!0,duration:3e3}),this.fetchData()):this.$message({type:"error",message:e.msg||"确认自提失败，请稍后再试",showClose:!0,duration:3e3})})).catch((e=>{t.close(),console.error(e),this.$message({type:"error",message:"确认自提出错，请稍后再试",showClose:!0,duration:3e3})}))})).catch((()=>{this.$message({type:"info",message:"已取消确认"})}))}}},c=l,u=s(1656),d=(0,u.A)(c,a,o,!1,null,null,null),h=d.exports}}]);
//# sourceMappingURL=217.293b65f1.js.map